<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HTML JS API Homework</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <script src="js/bootstrap.bundle.min.js"></script>
    <style>
        body{
            font-family: "微軟正黑體";
            font-size: 18px;
        }
        [id^="area"]{

        }
        #areaSystem{
            width: 100%;
            background-color: burlywood;
            padding: 2px;
        }
        #areaData{
            background-color: beige;
            width: 250px;
            padding: 10px;
            text-align: center;
            float: left;
        }
        #areaDraw{
            float: left;
        }
        [id^="txtName"],[id^='txtSale']{
            width: 100px;
            height: 35px;
            margin: 5px;
            text-align: center;
        }
        #btnUpdate{
            border: 1px solid gray;
            margin-top: 10px;
            width: 220px;
        }
        span:first-child{
            margin-left: 5px;
            margin-right: 60px;
        }
        #selectPattern{
            margin-top: 10px;
            height: 40px;
        }
        
        svg{
            border: 1px solid red;
            width: 800px;
            height: 800px;
            margin-right: auto;
            margin-left: auto;
        }

        #axisX, #axisY {
            stroke: black;
            stroke-width: 2px;
        }

        polyline{
            stroke: green;
            stroke-width: 2px;
            fill: none;
        }
        circle{
            stroke: green;
            fill: green;
        }
        text.salesName{
            color: #5b41c8;
            font-size: 16px;
            background-color: #ffffff;
        }
        #txtWidth{
            margin-top: 10px;
        }
    </style>
</head>
<body onload="init()">
    <div>
        <div id="areaSystem">
            <h4 id="sysMessage"></h4>
        </div>
        <div id="areaData">
            <span>姓名</span><span>業績(千元)</span>
        </div>
        <div id="areaDraw">
            <svg id="svgDraw">

            </svg>
        </div>
    </div>
    <script>

        var db;
        var domMessage = document.getElementById('sysMessage');
        var domAreaData = document.getElementById('areaData');
        var domAreaDraw = document.getElementById('areaDraw');
        var domSvg = document.getElementById('svgDraw');
        var aryName = [];
        var arySale = [];
        var svgSize = 0, padLeft = 0, padTop = 0;
        var minData, maxData, overAll;
        function init() {
            if (indexedDB) {
                domMessage.textContent = '您的瀏覽器支援 indexedDB。';
            }
            else {
                domMessage.textContent = '抱歉您的瀏覽器不支援 indexedDB 無法使用'
                return;
            }

            InitializeUI();
            InitializeDatabase();

        }

        function InitializeDatabase() {
            let request = indexedDB.open('hykong20220215idbHW', 1);

            request.onerror = function (event) {
                domMessage.textContent += '資料庫開啟錯誤!';
                return;
            }

            request.onsuccess = function (event) {
                domMessage.textContent += "資料庫開啟順利，歡迎使用。";
                db = request.result;
                var index = 1
                let objStore = db.transaction(['tSalesman'], 'readonly').objectStore('tSalesman');
                objStore.openCursor().onsuccess = function (e) {
                    var cursor = e.target.result;
                    if (cursor) {
                        document.getElementById('txtName' + index).value = cursor.value.Name;
                        document.getElementById('txtSale' + index).value = cursor.value.Sale;
                        index++;
                        cursor.continue();
                    }
                    
                    
                }
            }

            request.onupgradeneeded = function (event) {
                domMessage.textContent += "資料庫初始化完成。";
                let initData = [
                    { "Name": "王天生", "Sale": 65 }, { "Name": "陳秀英", "Sale": 87 }, { "Name": "許來福", "Sale": 43 },
                    { "Name": "黃春嬌", "Sale": 72 }, { "Name": "李明", "Sale": 68 }, { "Name": "林玉蘭", "Sale": 95 },
                    { "Name": "黃武雄", "Sale": 55 }, { "Name": "洪文雄", "Sale": 31 }, { "Name": "陳金龍", "Sale": 48 },
                    { "Name": "吳玉英", "Sale": 70 }, { "Name": "林文雄", "Sale": 65 }, { "Name": "張美玉", "Sale": 85 }
                ];
                db = request.result;
                let objStore = db.createObjectStore("tSalesman", { key: 'id', autoIncrement: true });
                for (let data of initData) {
                    objStore.add(data);
                }
            }

        }

        function InitializeUI() {
            for (let i = 1; i <= 12; i++) {
                let domDiv = document.createElement('div');
                domDiv.setAttribute('id', 'divMan' + i);
                let txtName = document.createElement('input');
                txtName.setAttribute('type', 'text');
                txtName.setAttribute('id', 'txtName' + i);
                let txtSale = document.createElement('input');
                txtSale.setAttribute('type', 'number');
                txtSale.setAttribute('id', 'txtSale' + i);
                domDiv.appendChild(txtName);
                domDiv.appendChild(txtSale);

                txtName.addEventListener('blur', RefreshSVG);
                txtSale.addEventListener('change', RefreshSVG);
                domAreaData.appendChild(domDiv);
            }
            let domBtn = document.createElement('button');
            domBtn.setAttribute('id', 'btnUpdate');
            domBtn.textContent = '更新至資料庫';
            domBtn.addEventListener('click', UpdateData);
            domAreaData.appendChild(domBtn);

            let domSelect = document.createElement('select');
            let optName = ['統計圖表','折線圖', '長條圖', '圓餅圖'];
            for (let i in optName) {
                let opt = document.createElement('option');
                opt.textContent = optName[i];
                opt.setAttribute('value', i);
                domSelect.appendChild(opt);
            }
            domSelect.setAttribute('id', 'selectPattern');
            domSelect.addEventListener('change', RefreshSVG);
            domAreaData.appendChild(domSelect);

            let divWidth = document.createElement('div');
            divWidth.textContent = '畫布大小：';
            //let txtWidth = document.createElement('span');
            //txtWidth.textContent = '畫布大小： ';
            //txtWidth.style.width = '80px';
            //divWidth.appendChild(txtWidth);
            let domWidth = document.createElement('input');
            domWidth.setAttribute('id', 'txtWidth');
            domWidth.setAttribute('type', 'number');
            domWidth.setAttribute('value', 800);
            domWidth.setAttribute('max', 1000);
            domWidth.setAttribute('min', 500);
            domWidth.setAttribute('step', 50);
            domWidth.addEventListener('change', RefreshSVG);
            divWidth.appendChild(domWidth);
            domAreaData.appendChild(divWidth);
        }

        function RefreshSVG() {
            let chartSelect = document.getElementById('selectPattern').value;
            if (chartSelect == 0) {
                domSvg.innerHTML = '';
                return;
            }

            RefreshData();
            let windowWidth = window.innerWidth * 4 / 5;
            svgSize = document.getElementById('txtWidth').value;
            
            domAreaDraw.style.width = (windowWidth - 260) + 'px';
            domSvg.style.width = svgSize+ 'px';
            domSvg.style.height = svgSize + 'px';

            padLeft = svgSize / 10;
            padTop = svgSize / 10;

            if (chartSelect == 1) {
                DrawLineChart();
            }
            else if (chartSelect == 2) {
                DrawBarChart();
            }
            else {
                DrawPieChart();
            }
        }

        function RefreshData() {
            aryName = [];
            arySale = [];
            for (let i = 1; i <= 12; i++) {
                aryName.push(document.getElementById('txtName' + i).value);
                arySale.push(parseInt(document.getElementById('txtSale' + i).value));
            }
            minData = arySale[0], maxData = arySale[0];
            for (let sale of arySale) {                 // 求資料裡最大最小值
                if (sale > maxData) {                   // 分布要用
                    maxData = sale;
                }
                if (sale < minData) {
                    minData = sale;
                }
            }
            overAll = maxData - minData;                // 全距

        }
        function DrawLineChart() {
            domSvg.innerHTML = '';
            generateAxis();

            let distance = (svgSize - padLeft * 4) / 11;
            let totalHeight = svgSize - padTop * 4;
            let poly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            let points = [];
            for (let i = 0; i < 12; i++) {
                let ratio = overAll == 0 ? 0.5 : (arySale[i] - minData) / overAll;
                let pointX = padLeft * 2 + distance * i;
                let pointY = padTop * 2 + totalHeight * (1 - ratio);
                points.push(`${pointX},${pointY}`);

                let circ = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circ.setAttribute('cx', pointX);
                circ.setAttribute('cy', pointY);
                circ.setAttribute('r', 3);
                domSvg.appendChild(circ);

                let text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.textContent = aryName[i];
                text.className = 'salesName';
                let locY = 0;                               // 調整人名的 y 軸位置
                if (i == 0) {                               // 人名最左，若往右上升，y往下移
                    if (arySale[i] < arySale[1]) {
                        locY = pointY + 30;
                    }
                    else {                                  // 人名最左，若往右下降，y往上移
                        locY = pointY - 10;
                    }
                }
                else if (i == 11) {                         // 人名最右，若往左上升，y往下移
                    if (arySale[10] > arySale[11]) {
                        locY = pointY + 30;
                    }
                    else {                                  // 人名最右，若往左下降，y往上移
                        locY = pointY - 10;
                    }
                }
                else {                                      // 人名在中間，若兩邊往上升，y往下移
                    if (arySale[i - 1] >= arySale[i] && arySale[i] <= arySale[i + 1]) {
                        locY = pointY + 30;
                    }
                    else {                                  // 其餘情形(一邊高一邊低、或往兩邊下降)，y往上移
                        locY = pointY - 10;
                    }
                }
                text.setAttribute('x', pointX - 20);
                text.setAttribute('y', locY);
                domSvg.appendChild(text);
            }
            poly.setAttribute('points', points.join(' '));      // 折線的點
            domSvg.appendChild(poly);

            let distanceY = maxData == minData ? 0 : (svgSize - padTop * 4) / (maxData - minData);

            for (let i = minData - 2 ; i <= maxData + 2; i++) {
                let ySegment = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                let ratio = (arySale[i] - minData) / overAll;
                ySegment.setAttribute('x1', padLeft);
                ySegment.setAttribute('y1', padTop * 2 + distanceY * (maxData - i));
                ySegment.setAttribute('x2', padLeft +10);
                ySegment.setAttribute('y2', padTop * 2  + distanceY * (maxData - i ));
                ySegment.setAttribute('stroke', 'black');
                ySegment.setAttribute('strokeWidth', '2px');
                domSvg.appendChild(ySegment);
            }
        }

        function DrawBarChart() {
            domSvg.innerHTML = '';
            generateAxis();
        }

        function DrawPieChart() {
            domSvg.innerHTML = '';
        }


        function UpdateData() {

        }

        function generateAxis() {               // Reference:  https://stackoverflow.com/questions/7547117/add-a-new-line-in-svg-bug-cannot-see-the-line
            let axisX = document.createElementNS('http://www.w3.org/2000/svg','line');      // use document.createElementNS() namespace??
            axisX.setAttribute('x1', padLeft);
            axisX.setAttribute('y1', svgSize - padTop);
            axisX.setAttribute('x2', svgSize - padLeft);
            axisX.setAttribute('y2', svgSize - padTop);
            axisX.setAttribute('id', 'axisX');
            domSvg.appendChild(axisX);
            console.log(domSvg);

            let axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            axisY.setAttribute('x1', padLeft);
            axisY.setAttribute('y1', svgSize - padTop);
            axisY.setAttribute('x2', padLeft);
            axisY.setAttribute('y2', padTop);
            axisY.setAttribute('id', 'axisY');
            domSvg.appendChild(axisY);
        }
    </script>
</body>
</html>